/*
 * SPDX-FileCopyrightText: Copyright (c) 2026, NVIDIA CORPORATION. All rights reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

#include "header.h"

static const double threshold[] = {
  331.50000000000006, 380.50000000000006, 444.00000000000006, 454.50000000000006,
  519.50000000000011, 555.00000000000011, 1454.0000000000002, 1496.5000000000002,
  2448.5000000000005, 4115.0000000000009, 4305.5000000000009, 4839.5000000000009,
  5346.5000000000009, 6228.5000000000009, 9689.5000000000018, 14879.500000000002,
  15693.000000000002, 17345.000000000004, 21083.000000000004, 24144.500000000004,
  34410.500000000007, 36239.500000000007, 37842.500000000007, 40918.500000000007,
  46263.500000000007, 50138.000000000007, 60708.500000000007, 72207.000000000015,
  77439.500000000015, 79608.500000000015, 91121.000000000015, 93826.000000000015,
  104579.50000000001, 163887.00000000003, 202377.00000000003, 221228.50000000003,
  246546.00000000003, 298845.00000000006, 323110.00000000006, 344863.50000000006,
  510463.50000000006, 1645.0000000000002, 1709.0000000000002, 3059.5000000000005,
  3953.5000000000005, 4013.0000000000005, 4025.5000000000005, 4837.5000000000009,
  5585.5000000000009, 5832.5000000000009, 6329.5000000000009, 6829.0000000000009,
  7266.0000000000009, 9604.5000000000018, 10543.000000000002, 11316.000000000002,
  13942.500000000002, 18312.500000000004, 20001.500000000004, 26121.500000000004,
  28899.500000000004, 31929.000000000004, 41385.000000000007, 49239.000000000007,
  52480.000000000007, 55778.000000000007, 59927.500000000007, 65717.000000000015,
  75092.000000000015, 106578.00000000001, 114790.50000000001, 120166.00000000001,
  125666.50000000001, 238985.00000000003, 257730.50000000003, 304621.00000000006,
  345125.50000000006, 467574.50000000006, 538765.50000000012, 600167.00000000012,
  651989.00000000012, 492.50000000000006, 6278.5000000000009, 7445.5000000000009,
  9808.5000000000018, 11088.500000000002, 12428.500000000002, 15493.000000000002,
  17632.500000000004, 20808.500000000004, 22190.000000000004, 22709.500000000004,
  23707.500000000004, 36926.500000000007, 38191.000000000007, 44292.000000000007,
  45843.000000000007, 47541.500000000007, 52712.500000000007, 54350.500000000007,
  59809.000000000007, 63098.000000000007, 68639.000000000015, 80444.000000000015,
  92079.500000000015, 98182.500000000015, 123427.00000000001, 125177.00000000001,
  167577.00000000003, 174836.00000000003, 186265.50000000003, 188362.00000000003,
  197007.50000000003, 211368.00000000003, 249795.00000000003, 260021.00000000003,
  266201.00000000006, 289613.50000000006, 292623.50000000006, 309845.50000000006,
  313121.50000000006, 319213.00000000006, 327694.00000000006, 336320.00000000006,
  388897.00000000006, 431435.50000000006, 443736.50000000006, 499102.50000000006,
  504094.00000000006, 547807.50000000012, 587180.00000000012, 603657.50000000012,
  624274.00000000012, 647468.00000000012, 699833.00000000012, 734235.50000000012,
  757689.00000000012, 780010.50000000012, 962875.00000000012, 1164224.5000000002,
  1416361.0000000002, 1630053.5000000002, 1863835.0000000002, 1921521.0000000002,
  1971655.0000000002, 1989499.0000000002, 2005190.0000000002, 2018692.0000000002,
  2032598.0000000002, 2092776.0000000002, 2836397.5000000005, 3398604.0000000005,
  3442503.5000000005, 3897359.5000000005, 5191813.5000000009, 5694629.5000000009,
  6838622.5000000009, 8540143.0000000019, 6310.0000000000009, 43748.000000000007,
  50829.500000000007, 69946.000000000015, 79995.000000000015, 110786.50000000001,
  140480.00000000003, 147046.50000000003, 180637.50000000003, 211441.50000000003,
  299525.50000000006, 386595.00000000006, 412447.00000000006, 430914.00000000006,
  474762.00000000006, 497602.00000000006, 587288.00000000012, 706723.50000000012,
  781740.50000000012, 853522.00000000012, 997296.00000000012, 1065333.0000000002,
  1204174.5000000002, 1222545.5000000002, 1806119.5000000002, 1879308.0000000002,
  1940828.0000000002, 2238905.0000000005, 2573759.0000000005, 7308634.0000000009,
};

static const int th_begin[] = {
  0,
  41,
  81,
  158,
  188,
};

static const int th_len[] = {
  41,
  40,
  77,
  30,
  0,
};

/*
 * \brief Function to convert a feature value into bin index.
 * \param val Feature value, in floating-point
 * \param fid Feature identifier
 * \return bin Index corresponding to given feature value
 */
int bounds_strengthening_predictor::quantize(double val, unsigned fid)
{
  const size_t offset = th_begin[fid];
  const double* array = &threshold[offset];
  int len             = th_len[fid];
  int low             = 0;
  int high            = len;
  int mid;
  double mval;
  // It is possible th_begin[i] == [total_num_threshold]. This means that
  // all features i, (i+1), ... are not used for any of the splits in the model.
  // So in this case, just return something
  if (offset == 188 || val < array[0]) { return -10; }
  while (low + 1 < high) {
    mid  = (low + high) / 2;
    mval = array[mid];
    if (val == mval) {
      return mid * 2;
    } else if (val < mval) {
      high = mid;
    } else {
      low = mid;
    }
  }
  if (array[low] == val) {
    return low * 2;
  } else if (high == len) {
    return len * 2;
  } else {
    return low * 2 + 1;
  }
}
