/*
 * SPDX-FileCopyrightText: Copyright (c) 2025-2026, NVIDIA CORPORATION. All rights reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

#include "header.h"

static const float threshold[] = {
  17,
  26,
  31,
  52,
  56,
  58,
  60,
  69,
  86,
  145,
  156,
  160,
  210,
  214,
  219,
  253,
  269,
  272,
  365,
  420,
  479,
  504,
  511,
  649,
  655,
  770,
  780,
  784,
  875,
  888,
  955,
  1024,
  1106,
  1184,
  1187,
  1216,
  1344,
  1400,
  1455,
  1635,
  2025,
  2036,
  2164,
  2272,
  2303,
  2376,
  2442,
  2595,
  2600,
  3034,
  3060,
  3073,
  3079,
  3261,
  3338,
  3472,
  3510,
  3561,
  3654,
  4009,
  4171,
  4272,
  4462,
  4484,
  4704,
  4745,
  4768,
  4798,
  5068,
  5376,
  5662,
  5942,
  5951,
  5956,
  5958,
  6260,
  6481,
  6483,
  6730,
  6868,
  7389,
  7418,
  7745,
  8538,
  10218,
  10720,
  11185,
  11928,
  12414,
  12631,
  12927,
  13410,
  13688,
  13839,
  13869,
  14060,
  14099,
  14370,
  14636,
  15977,
  17187,
  17188,
  18405,
  18865,
  20602,
  20849,
  22480,
  23530,
  23836,
  24923,
  27542,
  29397,
  29435,
  30199,
  32450,
  33154,
  35734,
  37616,
  37648,
  37816,
  40272,
  53593,
  62171,
  63708,
  72468,
  74873,
  74884,
  74918,
  78287,
  86262,
  94595,
  129171,
  129931,
  138056,
  167056,
  184865,
  268358,
  1428996,
  8,
  12,
  13,
  40,
  41,
  45,
  46,
  49,
  61,
  108,
  112,
  126,
  130,
  158,
  162,
  225,
  234,
  241,
  242,
  260,
  270,
  296,
  322,
  332,
  359,
  360,
  397,
  403,
  443,
  444,
  447,
  448,
  482,
  483,
  484,
  487,
  566,
  569,
  577,
  582,
  643,
  659,
  711,
  721,
  723,
  764,
  811,
  867,
  879,
  900,
  1005,
  1025,
  1299,
  1389,
  1500,
  1513,
  1573,
  1634,
  1653,
  1691,
  1759,
  1863,
  1898,
  1917,
  1947,
  2225,
  2301,
  2344,
  2362,
  2366,
  2372,
  2376,
  2433,
  2472,
  2522,
  2526,
  2898,
  3174,
  3249,
  3250,
  3480,
  3491,
  3492,
  3760,
  3897,
  3925,
  4234,
  4241,
  4424,
  4454,
  4463,
  4634,
  4660,
  4811,
  4813,
  5190,
  5594,
  6120,
  6323,
  6333,
  6654,
  6754,
  6894,
  6956,
  8469,
  8620,
  10427,
  10479,
  11334,
  13361,
  14040,
  14766,
  16027,
  16488,
  16925,
  16927,
  18304,
  18609,
  22191,
  24885,
  24971,
  30499,
  32737,
  32933,
  37617,
  43882,
  45221,
  48604,
  53361,
  59577,
  67584,
  99790,
  131866,
  146326,
  169577,
  259962,
  314413,
  2881228,
  11,
  90,
  130,
  300,
  403,
  463,
  480,
  840,
  916,
  1011,
  1023,
  1035,
  1602,
  2221,
  2298,
  2710,
  3120,
  3382,
  3456,
  3718,
  4448,
  4496,
  4875,
  5096,
  5849,
  5940,
  6208,
  6498,
  7023,
  7490,
  7592,
  7755,
  7875,
  8379,
  8991,
  9168,
  9180,
  9714,
  10300,
  10530,
  12612,
  12613,
  14030,
  14576,
  15688,
  17774,
  19143,
  20810,
  22736,
  23965,
  26394,
  29040,
  30477,
  30489,
  31720,
  39920,
  40392,
  43256,
  43305,
  43345,
  43357,
  47777,
  48695,
  50150,
  58368,
  59790,
  65145,
  78260,
  83617,
  94254,
  101208,
  102473,
  110022,
  113048,
  118141,
  119459,
  127416,
  132112,
  147024,
  152533,
  154570,
  178965,
  182574,
  185099,
  187236,
  187968,
  188780,
  203770,
  210725,
  228952,
  228988,
  229044,
  247107,
  271063,
  283189,
  283914,
  293410,
  295358,
  302709,
  319705,
  346211,
  409850,
  433829,
  518476,
  648112,
  648715,
  834722,
  858766,
  1024230,
  1632480,
  1697945,
  2087795,
  2192958,
  4313301,
  2.4999999e-05,
  2.9000001e-05,
  3.7999998e-05,
  4.7000001e-05,
  5.3e-05,
  5.6000001e-05,
  5.9000002e-05,
  7.8999998e-05,
  7.9999998e-05,
  0.000109,
  0.00012899999,
  0.000157,
  0.00017499999,
  0.000181,
  0.000199,
  0.000256,
  0.00028000001,
  0.000283,
  0.00028400001,
  0.000287,
  0.000397,
  0.000401,
  0.00045200001,
  0.00047299999,
  0.00050600001,
  0.00053899997,
  0.00056000001,
  0.00062599999,
  0.00067400001,
  0.00072399998,
  0.00079299998,
  0.00090599997,
  0.001052,
  0.001054,
  0.001064,
  0.00107,
  0.001084,
  0.00122,
  0.001233,
  0.001236,
  0.001297,
  0.001321,
  0.001404,
  0.001618,
  0.001706,
  0.001785,
  0.001862,
  0.0020570001,
  0.0021569999,
  0.002267,
  0.0025269999,
  0.002664,
  0.00278,
  0.0029440001,
  0.003064,
  0.0030789999,
  0.0031069999,
  0.003267,
  0.0032800001,
  0.003491,
  0.0038409999,
  0.0039599999,
  0.0040600002,
  0.0042429999,
  0.004373,
  0.0047650002,
  0.0049749999,
  0.0053010001,
  0.005316,
  0.0054930001,
  0.0055149999,
  0.005903,
  0.0061130002,
  0.0071859998,
  0.007557,
  0.0079190005,
  0.0082029998,
  0.0083109997,
  0.0085450001,
  0.0088409996,
  0.008986,
  0.0096119996,
  0.010158,
  0.010454,
  0.010491,
  0.010588,
  0.011062,
  0.011189,
  0.01136,
  0.011947,
  0.012388,
  0.01285,
  0.013316,
  0.014028,
  0.014862,
  0.017344,
  0.017529,
  0.018440999,
  0.019753,
  0.020732,
  0.021379,
  0.024308,
  0.028986,
  0.029084001,
  0.029973,
  0.031771,
  0.032212,
  0.032758001,
  0.036036,
  0.036471002,
  0.048811998,
  0.048967998,
  0.057353001,
  0.064516,
  0.087884001,
  0.101821,
  0.13953499,
  0.14706101,
  0.229167,
  0.231547,
  0.258656,
  0.26689899,
  0.329083,
  0.34957099,
  0.35977599,
  0.42875499,
  0.91632003,
  0.073445998,
  0.233594,
  0.27638501,
  0.38584599,
  0.39129001,
  0.39430001,
  0.47627199,
  0.49999601,
  0.64261901,
  0.75658399,
  0.767389,
  0.84350997,
  1.015707,
  1.1055419,
  1.15354,
  1.4087991,
  1.722888,
  1.833473,
  1.891134,
  1.944816,
  2.2556751,
  2.4810159,
  2.66401,
  3.046876,
  3.5996871,
  3.6403749,
  4.273489,
  4.50634,
  5.4227982,
  5.6764622,
  6.6741581,
  6.9359412,
  6.9459491,
  9.0884533,
  9.3204279,
  11.047834,
  11.05003,
  11.34829,
  11.977816,
  12.56616,
  12.896968,
  13.082605,
  13.121695,
  15.218937,
  15.219805,
  15.422595,
  15.908748,
  16.333834,
  16.442045,
  17.222109,
  18.255583,
  18.337471,
  18.482592,
  19.853386,
  20.08359,
  20.493109,
  20.575439,
  21.781368,
  21.850649,
  23.025219,
  23.394861,
  23.543165,
  24.943169,
  26.903715,
  29.262121,
  30.220488,
  30.346951,
  30.993811,
  31.029835,
  32.219078,
  34.479328,
  39.028454,
  39.205608,
  39.3573,
  43.941006,
  44.133533,
  49.547768,
  52.339855,
  53.529537,
  56.239407,
  57.230946,
  60.911472,
  61.411575,
  66.006073,
  75.513832,
  76.959404,
  79.399498,
  94.297729,
  101.50806,
  104.90943,
  108.45773,
  125.96421,
  131.78522,
  149.06885,
  149.10501,
  159.80826,
  166.47375,
  190.44113,
  193.85234,
  214.411,
  228.99097,
  243.77342,
  251.07321,
  265.90009,
  277.75555,
  290.5871,
  321.94229,
  349.17996,
  435.58398,
  461.15714,
  480.75259,
  555.98761,
  556.20483,
  632.65863,
  828.06183,
  836.67456,
  857.39771,
  1038.6504,
  1445.1395,
  2359.3203,
  2750.1714,
  3077.2048,
  3270.0989,
  3929.8506,
  3954.1118,
  5246.2725,
  7567.3979,
  14218.984,
  0.0041490002,
  0.036821999,
  0.049214002,
  0.130913,
  0.177389,
  0.18044201,
  0.183018,
  0.19227199,
  0.244839,
  0.30151099,
  0.33716401,
  0.33797899,
  0.33922401,
  0.376284,
  0.436288,
  0.488325,
  0.50635898,
  0.51155603,
  0.53070199,
  0.55729002,
  0.576186,
  0.60621798,
  0.62735999,
  0.63285798,
  0.64827198,
  0.69477397,
  0.727198,
  0.74622601,
  0.76021701,
  0.77570999,
  0.817267,
  0.84039903,
  0.874892,
  0.88309401,
  0.91301,
  0.914644,
  0.92933702,
  0.94280899,
  1.017756,
  1.11876,
  1.1953419,
  1.205152,
  1.207976,
  1.208634,
  1.295553,
  1.2959141,
  1.326723,
  1.347288,
  1.3574491,
  1.390246,
  1.390783,
  1.428421,
  1.4407949,
  1.45542,
  1.502932,
  1.5636179,
  1.581139,
  1.78348,
  1.78504,
  1.801465,
  1.873001,
  2.0050731,
  2.062494,
  2.1306751,
  2.1410699,
  2.142792,
  2.1604609,
  2.301403,
  2.3202839,
  2.320334,
  2.342221,
  2.3494289,
  2.392698,
  2.4694431,
  2.4709809,
  2.548645,
  2.7524309,
  2.8433869,
  2.8817151,
  2.9853411,
  3.0516059,
  3.0590241,
  3.1028869,
  3.2358611,
  3.3461559,
  3.357758,
  3.364897,
  3.3847311,
  3.4308331,
  3.538095,
  3.712795,
  3.7464709,
  3.7710979,
  4.0210929,
  4.3894181,
  4.4247661,
  4.4356871,
  4.64078,
  4.7781639,
  5.100903,
  5.298172,
  5.2985978,
  5.4433179,
  5.4726572,
  5.5151229,
  5.6058269,
  5.6186318,
  5.738615,
  5.7462459,
  5.792984,
  5.9997821,
  6.0248361,
  6.1309428,
  6.1651001,
  6.6284609,
  7.162158,
  7.2263432,
  7.5340571,
  7.7937908,
  8.3784914,
  9.5885639,
  9.5996771,
  9.8454266,
  9.853548,
  10.502564,
  12.32793,
  13.122874,
  14.426889,
  15.470113,
  16.773743,
  19.316851,
  19.475534,
  22.584642,
  28.079082,
  46.668407,
  9,
  12,
  15,
  18,
  21,
  24,
  27,
  30,
  60,
  90,
  120,
  150,
  1620,
  7800,
  13500,
  24200,
  25700,
  28800,
  45400,
  55000,
  60400,
  61900,
  72000,
  96100,
  104000,
  106000,
  133000,
  137000,
  138000,
  152000,
  155000,
  177000,
  191000,
  222000,
  240000,
  264000,
  288000,
  304000,
  333000,
  345000,
  391000,
  408000,
  425000,
  449000,
  468000,
  518000,
  554000,
  583000,
  665000,
  719000,
  731000,
  756000,
  757000,
  772000,
  837000,
  931000,
  975000,
  1050000,
  1060000,
  1120000,
  1150000,
  1160000,
  1210000,
  1350000,
  1440000,
  1740000,
  1820000,
  1830000,
  1890000,
  2020000,
  2400000,
  2430000,
  2550000,
  2600000,
  2680000,
  2760000,
  2870000,
  2920000,
  3050000,
  3310000,
  3410000,
  3500000,
  3590000,
  3630000,
  3740000,
  3850000,
  3910000,
  4360000,
  4570000,
  4760000,
  5080000,
  5660000,
  6060000,
  6070000,
  6150000,
  6490000,
  6500000,
  6600000,
  6780000,
  7090000,
  7170000,
  8100000,
  8760000,
  9040000,
  9270000,
  10700000,
  11300000,
  11600000,
  12100000,
  12600000,
  12700000,
  13700000,
  14100000,
  15200000,
  15900000,
  16500000,
  17100000,
  17600000,
  17900000,
  19200000,
  20800000,
  22500000,
  23200000,
  26000000,
  26800000,
  27800000,
  31100000,
  31400000,
  31600000,
  31700000,
  34300000,
  34400000,
  37100000,
  39800000,
  42800000,
  44300000,
  45400000,
  51500000,
  51900000,
  56600000,
  61500000,
  65100000,
  77500000,
  78400000,
  97200000,
  1.07e+08,
  1.24e+08,
  1.29e+08,
  1.34e+08,
  1.54e+08,
  2.14e+08,
  2.49e+08,
  3.13e+08,
  3.34e+08,
  5.06e+08,
  1.34e+09,
};

static const int th_begin[] = {
  0,
  138,
  276,
  390,
  517,
  645,
  780,
  792,
};

static const int th_len[] = {
  138,
  138,
  114,
  127,
  128,
  135,
  12,
  144,
};

/*
 * \brief Function to convert a feature value into bin index.
 * \param val Feature value, in floating-point
 * \param fid Feature identifier
 * \return bin Index corresponding to given feature value
 */
int pdlp_predictor::quantize(float val, unsigned fid)
{
  const size_t offset = th_begin[fid];
  const float* array  = &threshold[offset];
  int len             = th_len[fid];
  int low             = 0;
  int high            = len;
  int mid;
  float mval;
  // It is possible th_begin[i] == [total_num_threshold]. This means that
  // all features i, (i+1), ... are not used for any of the splits in the model.
  // So in this case, just return something
  if (offset == 936 || val < array[0]) { return -10; }
  while (low + 1 < high) {
    mid  = (low + high) / 2;
    mval = array[mid];
    if (val == mval) {
      return mid * 2;
    } else if (val < mval) {
      high = mid;
    } else {
      low = mid;
    }
  }
  if (array[low] == val) {
    return low * 2;
  } else if (high == len) {
    return len * 2;
  } else {
    return low * 2 + 1;
  }
}
